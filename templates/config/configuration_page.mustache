{{!
    This file is part of Moodle - https://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template plugintype_pluginname/template_name

    Template purpose and description.

    Classes required for JS:
    * none

    Data attributes required for JS:
    * none

    Context variables required for this template:
    * none

    Example context (json):
    {
    }
}}

{{! Form Management Section }}
<div class="card mt-4">
  <div id="region-main" class="region-main">
      <div class="card-body">
        <h2>{{#str}}formmanagementtitle, mod_smartspe{{/str}}</h2>
        {{! Forms table }}
        <table class="table table-striped">
          <colgroup>
            <col style="width:20%">
            <col style="width:0%">
            <col style="width:20%">
          </colgroup>
          <thead>
          <tr>
            <th style="text-align: left;">{{#str}}formsectiontitle, mod_smartspe{{/str}}</th>
            <th style="text-align: left;">{{#str}}formsectionstatus, mod_smartspe{{/str}}</th>
            <th style="text-align: center;">{{#str}}formsectionactions, mod_smartspe{{/str}}</th>
          </tr>
          </thead>
          {{! Form list }}
          <tbody>
          {{#forms}}
            <tr>
              <td>{{title}}</td>
              <td style="text-align: left;">{{statuslabel}}</td>
              <td style="text-align: center;">
                <div class="btn-group" role="group">
                  <div class="btn-group" role="group">
                    <span class="mr-2">{{{editbutton}}}</span>
                    <span class="mr-2">{{{publishbutton}}}</span>
                    <span class="mr-2">{{{archivebutton}}}</span>
                    <span class="mr-2">{{{deletebutton}}}</span>
                  </div>
                </div>
              </td>
            </tr>
          {{/forms}}
          {{! No forms message }}
          {{^forms}}
            <tr><td colspan="3">{{#str}}noformcreatedyet, mod_smartspe{{/str}}</td></tr>
          {{/forms}}
          </tbody>
        </table>

        {{! Create new form button }}
        <div>
          <a href="form_edit.php?id={{cmid}}" class="btn btn-primary">{{#str}}createnewform, mod_smartspe{{/str}}</a>
        </div>
      </div>
  </div>
</div>

{{! Report section }}
<div class="card mt-4">
  <div class="card-body">
    <h2>{{#str}}reportssectiontitle, mod_smartspe{{/str}}</h2>
    <hr>
    {{! Form selection dropdown }}
    <div class="mb-3">
      <form method="get" action="{{report.reporturl}}" class="d-inline">
        <input type="hidden" name="id" value="{{cmid}}">
        <select class="form-select w-auto d-inline" name="formid" onchange="this.form.submit()">
          <option value="">{{#str}}selectform, mod_smartspe{{/str}}</option>
          {{#report.formsdropdown}}
            <option value="{{id}}" {{#selected}}selected{{/selected}}>{{name}}</option>
          {{/report.formsdropdown}}
        </select>
      </form>
      &nbsp;
      {{! Team selection dropdown }}
      <form method="get" action="{{report.reporturl}}" class="d-inline">
        <input type="hidden" name="id" value="{{cmid}}">
        <input type="hidden" name="formid" value="{{report.formid}}">
        <select class="form-select d-inline w-auto" name="teamid" onchange="this.form.submit()">
          <option value="">{{#str}}selectteam, mod_smartspe{{/str}}</option>
          {{#report.teams}}
            <option value="{{id}}" {{#selected}}selected{{/selected}}>{{name}}</option>
          {{/report.teams}}
        </select>
      </form>
    </div>
    {{! Analysis results table }}
    <div id="analysis-results">
      {{#report.hasformselected}}
        {{#report.teamselected}}
          {{#report.matrix}}
            <div class="table-responsive">
              <table class="table table-striped table-hover smartspe-matrix">
                <thead>
                <!-- Header row A: targets across (one block per target) -->
                <tr>
                  <th colspan="{{leftcols}}"></th>
                  {{#targets}}
                    <th class="text-center" colspan="{{colspan}}">{{name}}</th>
                  {{/targets}}
                </tr>

                <!-- Header row B: left roster cols + per-target criteria labels -->
                <tr>
                  <th>Team</th>
                  <th>Student ID</th>
                  <th>Surname</th>
                  <th>Title</th>
                  <th>Given Name</th>
                  {{#targets}}
                    {{#criteria}}
                      <th>{{.}}</th>
                    {{/criteria}}
                    <th>{{#str}}averagefromeach, mod_smartspe{{/str}}</th>
                  {{/targets}}
                </tr>
                </thead>

                <tbody>
                <!-- One row per RATER (team member) -->
                {{#roster}}
                  <tr>
                    <td>{{team}}</td>
                    <td>{{studentid}}</td>
                    <td>{{surname}}</td>
                    <td>{{title}}</td>
                    <td>{{givenname}}</td>

                    <!-- One block per TARGET across this row -->
                    {{#blocks}}
                      {{#scores}}
                        <td class="{{#isself}}smartspe-self{{/isself}}">{{.}}</td>
                      {{/scores}}
                      <td class="{{#isself}}smartspe-self{{/isself}}">{{average}}</td>
                    {{/blocks}}
                  </tr>
                {{/roster}}
                </tbody>

                <tfoot>
                <!-- Footer: Average of Criteria for each target block -->
                <tr>
                  <th colspan="{{leftcols}}" class="text-end">{{#str}}averageofcriteria, mod_smartspe{{/str}}</th>
                  {{#targets}}
                    {{#avgpercriterion}}
                      <td>{{.}}</td>
                    {{/avgpercriterion}}
                    <td>{{overall}}</td>
                  {{/targets}}
                </tr>
                </tfoot>
              </table>
            </div>
          {{/report.matrix}}

          {{^report.matrix}}
            <p class="text-muted">{{#str}}selectteamtoviewreport, mod_smartspe{{/str}}</p>
          {{/report.matrix}}
        {{/report.teamselected}}

        {{^report.teamselected}}
          <p class="text-muted">{{#str}}selectteamtoviewreport, mod_smartspe{{/str}}</p>
        {{/report.teamselected}}
      {{/report.hasformselected}}

      {{^report.hasformselected}}
        <p class="text-muted">{{#str}}selectformtoviewreport, mod_smartspe{{/str}}</p>
      {{/report.hasformselected}}
    </div>
    <br>
    {{! Report buttons }}
    {{#report.hasformselected}}
      <span class="mr-2">
      <a href="{{report.viewsubmissionsurl}}" class="btn btn-primary">
        {{#str}}viewsubmissions, mod_smartspe{{/str}}
      </a>
    </span>
    {{/report.hasformselected}}
    {{^report.hasformselected}}
      <span class="mr-2">
      <button class="btn btn-primary" disabled
              title="{{#str}}selectformtoviewreport, mod_smartspe{{/str}}">
        {{#str}}viewsubmissions, mod_smartspe{{/str}}
      </button>
    </span>
    {{/report.hasformselected}}

      {{#report}}
        {{#canexport}}
          <span class="mr-2">
        <a href="{{exportcsvurl}}" class="btn btn-success">
          {{#str}}exportcsv, mod_smartspe{{/str}}
        </a>
      </span>
        {{/canexport}}
        {{^canexport}}
          <span class="mr-2">
        <button class="btn btn-success" disabled
                title="{{#str}}selectformandteam, mod_smartspe{{/str}}">
          {{#str}}exportcsv, mod_smartspe{{/str}}
        </button>
      </span>
        {{/canexport}}
      {{/report}}
    </div>
  </div>
</div>

{{! Back to course button }}
{{> mod_smartspe/partials/back_to_course }}
